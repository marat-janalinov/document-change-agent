# Анализ инструкций

**КРИТИЧЕСКИ ВАЖНО**: Найди ВСЕ инструкции по изменению текста в документе. Если в документе несколько инструкций (несколько изменений), ВСЕ они должны быть в массиве `changes`!

**ПОДСЧЕТ ИНСТРУКЦИЙ**: Перед генерацией JSON, подсчитай количество инструкций в документе. Каждая инструкция - это отдельное изменение и должна быть отдельным объектом в массиве `changes`.

## АЛГОРИТМ:

1. **ОПРЕДЕЛИ ТИП:**
   - ПАРАГРАФ: "в пункте" → REPLACE_TEXT
   - ТАБЛИЦА: "в таблице", "строку" → REPLACE_TEXT  
   - ДОКУМЕНТ: "по всему тексту" → REPLACE_TEXT (replace_all=true)

2. **ИЗВЛЕКИ target.text:**
   - Из кавычек в инструкции
   - НЕ номер пункта!

## ПРАВИЛА:
- Найди ВСЕ инструкции в документе
- Сохраняй порядок: CHG-001, CHG-002, CHG-003...
- Каждая инструкция = отдельный объект
- Если инструкция содержит несколько операций (разделенных "далее", "затем", "потом", "добавить"), РАЗБИВАЙ на отдельные операции

## РАЗБИЕНИЕ СЛОЖНЫХ ИНСТРУКЦИЙ:

Если в одной инструкции несколько действий, создавай отдельные операции:

**Пример 1:** "В пункте 32 слова X изложить: Y. Далее добавить пункт 33: [текст]"
→ CHG-001: REPLACE_TEXT (замена в пункте 32)
→ CHG-002: INSERT_PARAGRAPH (добавление пункта 33)

**Пример 2:** "Изменить текст X на Y. Затем вставить таблицу:" [таблица]
→ CHG-001: REPLACE_TEXT (замена X на Y)
→ CHG-002: INSERT_TABLE (вставка таблицы из документа инструкций)

**Пример 3:** "В таблице строку «ДРМ» изложить: «ДКР Департамент». Далее по тексту добавить пункт 34."
→ CHG-001: REPLACE_TEXT (замена в таблице)
→ CHG-002: INSERT_PARAGRAPH (добавление пункта 34)

## ПРИМЕРЫ:

**ТАБЛИЦА:** "В таблице строку «ДРМ» изложить: «ДКР Департамент кредитных рисков»"
```json
{
  "changes": [
    {
      "change_id": "CHG-001",
      "operation": "REPLACE_TEXT",
      "target": { "text": "ДРМ" },
      "payload": { "new_text": "ДКР Департамент кредитных рисков" },
      "description": "Изменение строки ДРМ в таблице"
    }
  ]
}
```

**ПАРАГРАФ:** "В пункте 32 слова «согласовывается с ДО и ДРМ» изложить: «согласовывается с ДО»"
```json
{
  "changes": [
    {
  "change_id": "CHG-002",
  "operation": "REPLACE_TEXT", 
  "target": { "text": "согласовывается с ДО и ДРМ" },
  "payload": { "new_text": "согласовывается с ДО" },
  "description": "Изменение слов в пункте 32"
    }
  ]
}
```

**МАССОВАЯ ЗАМЕНА:** "По всему тексту аббревиатуру «ДРМ» заменить аббревиатурой «ДКР»"
```json
{
  "changes": [
{
  "change_id": "CHG-003",
  "operation": "REPLACE_TEXT",
  "target": { "text": "ДРМ", "replace_all": true },
  "payload": { "new_text": "ДКР" },
  "description": "Массовая замена ДРМ на ДКР"
    }
  ]
}
```

**СЛОЖНАЯ ИНСТРУКЦИЯ (несколько операций):** "В пункте 32 слова X изложить: Y. Далее добавить пункт 33: [текст]"
→ Разбить на 2 операции:
```json
{
  "changes": [
{
  "change_id": "CHG-004",
  "operation": "REPLACE_TEXT",
  "target": { "text": "X" },
  "payload": { "new_text": "Y" },
  "description": "В пункте 32 слова X изложить: Y"
},
{
  "change_id": "CHG-005",
  "operation": "INSERT_PARAGRAPH",
  "target": { "after_text": "Y" },
  "payload": { "text": "33. [текст]" },
  "description": "Добавить пункт 33 после пункта 32"
    }
  ]
}
```

**ИНСТРУКЦИЯ С ТАБЛИЦЕЙ:** "Изменить текст X на Y. Затем вставить таблицу:" [таблица в документе]
→ Разбить на 2 операции:
```json
{
  "changes": [
{
  "change_id": "CHG-006",
  "operation": "REPLACE_TEXT",
  "target": { "text": "X" },
  "payload": { "new_text": "Y" },
  "description": "Изменить текст X на Y"
},
{
  "change_id": "CHG-007",
  "operation": "INSERT_TABLE",
  "target": { "after_text": "Y" },
  "payload": { 
    "rows": [["Заголовок1", "Заголовок2"], ["Данные1", "Данные2"]],
    "columns": ["Заголовок1", "Заголовок2"]
  },
  "description": "Вставить таблицу после текста Y"
}
  ]
}
```

**ТАБЛИЦА ПОСЛЕ "В СЛЕДУЮЩЕЙ РЕДАКЦИИ":** "В таблице строку «ПД» изложить в следующей редакции:" [таблица с новым содержимым]
→ Одна операция REPLACE_TEXT, где таблица содержит новое содержимое:
```json
{
  "changes": [
    {
      "change_id": "CHG-008",
      "operation": "REPLACE_TEXT",
      "target": { "text": "ПД" },
      "payload": { 
        "new_text": "Текст из таблицы (содержимое всех ячеек таблицы, объединенное или структурированное)"
      },
      "description": "В таблице строку «ПД» изложить в следующей редакции (из таблицы)"
    }
  ]
}
```

**ВАЖНО**: Если после "в следующей редакции:" идет ТАБЛИЦА, используй её содержимое как payload.new_text!

**ДОБАВИТЬ ПУНКТ С ТАБЛИЦЕЙ:** "В пункте 32 изложить в редакции: [текст]. Далее добавить пункт 33:" [таблица]
→ Разбить на 2 операции (СОХРАНИТЬ ПОРЯДОК):
```json
{
  "changes": [
    {
      "change_id": "CHG-009",
      "operation": "REPLACE_TEXT",
      "target": { "text": "текст из пункта 32" },
      "payload": { "new_text": "новый текст" },
      "description": "В пункте 32 изложить в редакции"
    },
    {
      "change_id": "CHG-010",
      "operation": "INSERT_PARAGRAPH",
      "target": { "after_text": "текст пункта 32 (после замены)" },
      "payload": { "text": "33. Содержимое из таблицы или текст" },
      "description": "Добавить пункт 33 после пункта 32"
    }
  ]
}
```

**ВАЖНО**: Определяй порядок операций по ключевым словам "далее", "затем", "потом" - они указывают на ПОСЛЕДОВАТЕЛЬНОСТЬ выполнения!

## КРИТИЧЕСКИЕ ПРАВИЛА:

❌ **НЕПРАВИЛЬНО:**
- target.text = "32" (номер пункта)
- target.text = "32." (номер пункта с точкой)
- target.text = "ПД Проектные дирекции" (полное содержимое вместо ключа)

✅ **ПРАВИЛЬНО:**
- target.text = "ДРМ" (ключевое слово из инструкции)
- target.text = "согласовывается с ДО и ДРМ" (точная фраза из инструкции)
- target.text = "ПД" (ключ из инструкции для таблицы)

**ВАЖНО:** Используй "new_text" в payload, НЕ "text"!

**КРИТИЧЕСКИ ВАЖНО - ФОРМАТ ОТВЕТА:**

Ты ДОЛЖЕН вернуть JSON в формате `{"changes": [...]}` где `changes` - это массив ВСЕХ найденных изменений!

✅ **ПРАВИЛЬНО**: 
```json
{
  "changes": [
    {"change_id": "CHG-001", "operation": "REPLACE_TEXT", ...},
    {"change_id": "CHG-002", "operation": "REPLACE_TEXT", ...},
    {"change_id": "CHG-003", "operation": "REPLACE_TEXT", ...}
  ]
}
```

❌ **НЕПРАВИЛЬНО**: 
```json
{"change_id": "CHG-001", "operation": "REPLACE_TEXT", ...}
```

**Если в документе найдено несколько инструкций, ВСЕ они должны быть в массиве `changes`! Не возвращай только одну инструкцию!**

**ПРИМЕР ОТВЕТА С НЕСКОЛЬКИМИ ИЗМЕНЕНИЯМИ:**
```json
{
  "changes": [
    {
      "change_id": "CHG-001",
      "operation": "REPLACE_TEXT",
      "target": { "text": "ДРМ" },
      "payload": { "new_text": "ДКР Департамент кредитных рисков" },
      "description": "Изменение строки ДРМ в таблице"
    },
    {
      "change_id": "CHG-002",
      "operation": "REPLACE_TEXT",
      "target": { "text": "согласовывается с ДО и ДРМ" },
      "payload": { "new_text": "согласовывается с ДО" },
      "description": "Изменение слов в пункте 32"
    },
    {
      "change_id": "CHG-003",
      "operation": "REPLACE_TEXT",
      "target": { "text": "ДРМ", "replace_all": true },
      "payload": { "new_text": "ДКР" },
      "description": "Массовая замена ДРМ на ДКР"
    }
  ]
}
```

**КРИТИЧЕСКИ ВАЖНО**: Если в документе найдено несколько инструкций, ВСЕ они должны быть в массиве `changes`! Не возвращай только один объект изменения - возвращай ВСЕ найденные изменения в массиве!

**ПЕРЕД ГЕНЕРАЦИЕЙ JSON**:
1. Прочитай весь документ инструкций
2. Подсчитай количество инструкций (изменений) в документе
3. Если инструкций несколько, ВСЕ должны быть в массиве `changes`
4. Каждая инструкция = отдельный объект с уникальным change_id (CHG-001, CHG-002, CHG-003...)

**ПРИМЕР С НЕСКОЛЬКИМИ ИНСТРУКЦИЯМИ**:

Если документ содержит:
- Инструкция 1: "Обновить версию API v1.2 на v2.0 в разделе 3.2"
- Инструкция 2: "Изменить текст X на Y в пункте 10"
- Инструкция 3: "Заменить аббревиатуру ДРМ на ДКР по всему тексту"

То ответ должен быть:
```json
{
  "changes": [
    {
      "change_id": "CHG-001",
      "operation": "REPLACE_TEXT",
      "target": { "text": "версия API v1.2" },
      "payload": { "new_text": "версия API v2.0" },
      "description": "Обновление версии API в разделе 3.2"
    },
    {
      "change_id": "CHG-002",
      "operation": "REPLACE_TEXT",
      "target": { "text": "X" },
      "payload": { "new_text": "Y" },
      "description": "Изменение текста X на Y в пункте 10"
    },
    {
      "change_id": "CHG-003",
      "operation": "REPLACE_TEXT",
      "target": { "text": "ДРМ", "replace_all": true },
      "payload": { "new_text": "ДКР" },
      "description": "Массовая замена ДРМ на ДКР"
    }
  ]
}
```

**НЕ ДОПУСТИМО** возвращать только первую инструкцию! Все найденные инструкции должны быть в массиве!

Преобразуй найденные инструкции в валидный JSON в формате `{"changes": [...]}`.