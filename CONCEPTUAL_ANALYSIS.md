# Концептуальный анализ проблем с сохранением изменений

## Проблема 1: Изменения логируются как успешные, но не фиксируются в файле

### Корневая причина:

**MCP `replace_text` возвращает `True`, но может не сохранять файл на диске.**

### Детальный анализ:

1. **Последовательность вызовов для локальной замены:**
   ```
   _handle_replace_text()
   ├─ Попытка стандартной замены (не срабатывает)
   ├─ Попытка надежной замены (не срабатывает)
   ├─ Попытка MCP replace_text
   │  ├─ doc.save(filename) ПЕРЕД вызовом MCP (сохраняет СТАРУЮ версию!)
   │  ├─ mcp_client.replace_text() → возвращает True
   │  └─ Верификация: проверяет файл, но MCP может не сохранить
   │     └─ Если верификация не прошла → локальная замена
   │        └─ Но к этому моменту replaced=True уже может быть установлен!
   └─ doc.save(filename) в конце (но только если replaced=True)
   ```

2. **Проблема в логике:**
   - На строке 4733: `doc.save(filename)` вызывается **ПЕРЕД** MCP - это сохраняет старую версию!
   - MCP `replace_text` может вернуть `True`, но не сохранить файл
   - Верификация проверяет файл, но если MCP не сохранил, изменения теряются
   - Локальная замена вызывается только если верификация не прошла, но к этому моменту `replaced = True` уже может быть установлен

3. **Почему массовая замена работает:**
   ```
   if replace_all or is_global_change:
       doc = Document(filename)  # НОВЫЙ объект документа
       # ... делаем замены ...
       doc.save(filename)  # ЯВНОЕ сохранение после всех изменений
   ```
   - Массовая замена идет **отдельным путем** (строка 4437-4468)
   - Создает **новый** объект `Document(filename)`
   - Делает все замены
   - **Явно вызывает** `doc.save(filename)` на строке 4468
   - Это гарантирует сохранение

4. **Почему комментарии работают:**
   - Комментарии используют MCP `add_comment`
   - MCP сервер **сохраняет файл** на своей стороне после добавления комментария
   - Это отдельный механизм, который работает независимо

## Проблема 2: Находится только одна инструкция

### Корневая причина:

**LLM возвращает один объект вместо массива `{"changes": [...]}`**

### Детальный анализ:

1. **Промпты:**
   - В промптах были примеры с одним объектом БЕЗ массива `changes`
   - Это вводило LLM в заблуждение
   - **Исправлено**: все примеры теперь показывают структуру с массивом

2. **Логика восстановления JSON:**
   - `_recover_json_structure` оборачивает один объект в массив
   - Но это все равно означает, что LLM вернул только один объект
   - Проблема в том, что LLM не читает весь документ или останавливается на первой инструкции

3. **Почему это происходит:**
   - LLM может не следовать инструкции "прочитай весь документ"
   - Может останавливаться на первой найденной инструкции
   - Может не понимать, что нужно вернуть массив даже для одной инструкции

## Решение

### Для проблемы с сохранением:

1. **Изменить порядок вызовов:**
   - Сначала пробовать локальную замену (которая гарантированно сохраняет)
   - Только если локальная не сработала, пробовать MCP
   - После MCP всегда проверять результат и делать локальную замену если MCP не сохранил

2. **Убрать `doc.save(filename)` перед MCP:**
   - Это сохраняет старую версию и может перезаписать изменения

3. **Гарантировать сохранение:**
   - После любого успешного изменения всегда вызывать локальную замену для гарантии сохранения
   - Или явно вызывать `doc.save(filename)` после верификации

### Для проблемы с одной инструкцией:

1. **Усилить промпты:**
   - Добавить явные инструкции "прочитай весь документ"
   - Добавить примеры с множественными инструкциями
   - Добавить предупреждение "не останавливайся на первой инструкции"

2. **Улучшить логику восстановления:**
   - Если найден только один объект, предупреждать в логах
   - Попробовать извлечь дополнительные инструкции из исходного текста

## Критические моменты:

1. **MCP сервер может не сохранять файл** - нужно всегда проверять результат
2. **Локальная замена гарантированно сохраняет** - использовать ее как основной механизм
3. **Массовая замена работает** - потому что явно вызывает `doc.save(filename)`
4. **Комментарии работают** - потому что MCP сервер сохраняет файл для комментариев
5. **LLM может возвращать один объект** - нужно усилить промпты и логику восстановления

