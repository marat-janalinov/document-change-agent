# Руководство по работе с таблицами в Document Change Agent

## Проблемы, которые были решены

### ❌ Проблемы до исправления:
1. **Текст в таблицах не находился** - система пропускала совпадения в ячейках таблиц
2. **Замена в таблицах не работала** - инструкции распознавались, но не применялись
3. **Аннотации перемещались в начало документа** - все комментарии добавлялись в начало, а не к месту изменения
4. **Неполная замена текста** - не все вхождения заменялись при массовых операциях

### ✅ Что исправлено:
1. **Улучшен поиск в таблицах** - система теперь находит текст в ячейках таблиц
2. **Добавлена локальная замена** - если MCP не работает, используется python-docx
3. **Исправлена привязка аннотаций** - комментарии добавляются рядом с местом изменения
4. **Улучшен алгоритм замены** - полная замена параграфов с сохранением форматирования

---

## Как правильно формулировать инструкции для таблиц

### 1. Изменение текста в конкретной строке таблицы

**✅ Правильно:**
```
В таблице «Принятые сокращения и пояснения» строку «ДРМ» изложить в следующей редакции:
«ДКР Департамент кредитных рисков».
```

**✅ Альтернативный вариант:**
```
Заменить в таблице «ДРМ» на «ДКР Департамент кредитных рисков».
```

### 2. Массовая замена по всему документу

**✅ Правильно:**
```
По всему тексту аббревиатуру «ДРМ» заменить аббревиатурой «ДКР».
```

**✅ Альтернативный вариант:**
```
Заменить «ДРМ» на «ДКР» во всем документе.
```

### 3. Изменение в конкретной ячейке таблицы

**✅ Правильно:**
```
В таблице «Принятые сокращения и пояснения» в строке «ПД» заменить описание на:
«ПД Проектные дирекции 1,2,3,4,5,6.».
```

### 4. Комбинированные инструкции

**✅ Правильно:**
```
1. В таблице «Принятые сокращения и пояснения» строку «ДРМ» изложить в следующей редакции: «ДКР Департамент кредитных рисков».
2. В пункте 32 слова «согласовывается с ДО и ДРМ» изложить в следующей редакции: «согласовывается с ДО» далее по тексту.
3. По всему тексту аббревиатуру «ДРМ» заменить аббревиатурой «ДКР».
```

---

## Технические улучшения

### Улучшенный поиск в таблицах
```python
# Теперь система обрабатывает совпадения в таблицах
if paragraph_index is None:
    table_info = entry.get("table_info") or entry.get("location")
    if table_info:
        logger.info(f"Найден текст в таблице: {entry}")
        paragraph_index = -1  # Специальный индекс для таблиц
```

### Улучшенная замена в таблицах
```python
# Замена в таблицах с сохранением форматирования
for table in doc.tables:
    for row in table.rows:
        for cell in row.cells:
            for paragraph in cell.paragraphs:
                if old_text in paragraph.text:
                    # Полная замена параграфа с сохранением форматирования
                    first_run.text = paragraph.text.replace(old_text, new_text)
```

### Правильная привязка аннотаций
```python
# Аннотации добавляются к каждому измененному параграфу
for para_idx in affected_paragraphs:
    await self._add_annotation(filename, para_idx, change, extra=f'"{target_text}" → "{new_text}"')
```

---

## Рекомендации по использованию

### 1. Порядок выполнения инструкций
Рекомендуемый порядок для комплексных изменений:
1. **Сначала** - изменения в таблицах (конкретные строки)
2. **Затем** - изменения в тексте документа (конкретные пункты)
3. **В конце** - массовые замены по всему документу

### 2. Проверка результатов
После применения инструкций:
1. Проверьте все таблицы на корректность изменений
2. Убедитесь, что массовые замены применились ко всем вхождениям
3. Проверьте, что аннотации находятся рядом с местами изменений

### 3. Устранение проблем
Если изменения не применились:
1. Убедитесь, что текст в инструкции точно соответствует тексту в документе
2. Проверьте, нет ли лишних пробелов или символов
3. Для таблиц используйте точное содержимое ячейки

---

## Примеры успешных инструкций

### Пример 1: Изменение аббревиатуры в таблице
**Инструкция:**
```
В таблице «Принятые сокращения и пояснения» строку «ДРМ» изложить в следующей редакции:
«ДКР Департамент кредитных рисков».
```

**Результат:** ✅ Строка в таблице изменена, аннотация добавлена рядом с таблицей

### Пример 2: Массовая замена
**Инструкция:**
```
По всему тексту аббревиатуру «ДРМ» заменить аббревиатурой «ДКР».
```

**Результат:** ✅ Все вхождения "ДРМ" заменены на "ДКР", аннотации добавлены к каждому измененному параграфу

### Пример 3: Изменение в конкретном пункте
**Инструкция:**
```
В пункте 32 слова «согласовывается с ДО и ДРМ» изложить в следующей редакции:
«согласовывается с ДО» далее по тексту.
```

**Результат:** ✅ Текст в пункте 32 изменен, аннотация добавлена к пункту 32

---

## Диагностика проблем

### Если текст не заменяется в таблицах:
1. Проверьте точность текста в инструкции
2. Убедитесь, что используете содержимое ячейки целиком
3. Проверьте логи системы на наличие сообщений о локальной замене

### Если аннотации в неправильном месте:
1. Система теперь автоматически размещает аннотации рядом с изменениями
2. Для таблиц аннотации добавляются после таблицы
3. Для массовых замен - к каждому измененному параграфу

### Если не все вхождения заменились:
1. Убедитесь, что используете формулировку "по всему тексту"
2. Проверьте, что текст точно соответствует оригиналу
3. Система теперь использует улучшенный алгоритм поиска и замены

---

*Документ обновлен: Ноябрь 2024*  
*Версия: 2.0 (после исправления проблем с таблицами)*
